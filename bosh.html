<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head>
<title>Bosh-Technique-Like Echo-Client</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
<script type="text/javascript" src="js/jquery.js"></script>
</head>
<body>

<div id="bosh_start_first">Start First</div>
<div id="bosh_start_second">Start Second</div>
<div id="bosh_stop">Stop</div>
<div id="send_stuff">Stufff<input type="text" id="more_stuff" /></div>

<div id="messages" style="width: 400px; height: 300px; background-color: blue;"></div>

<script type="text/javascript">

$(document).ready(function(){
    
  // Hobs provides a simple websocket-compatible interface
  // for bidrectional communication.
  //
  // It utilizes websockets if available and falls back to utilizing
  // XmlHTTPRequest in a way similar to the
  // "BOSH Technique" (http://xmpp.org/extensions/xep-0124.html#technique).
  //
  // Hobs is named as an anagram after BOSH since it is inspired by the
  // the techniques but still different and is smaller... almost hobbit-like...
  
  // Hobs / Websocket interface
  
  // Ready-states
  var CONNECTING  = 0;
  var OPEN        = 1;
  var CLOSING     = 2;
  var CLOSED      = 3;
  
  Hobs = {};
  Hobs.url = '';                      // readonly attribute DOMString
  Hobs.readystate = null;             // readonly attribute unsigned short
  Hobs.bufferedAmount = null;         // readonly attribute unsigned long
  
  // Networking
  Hobs.onopen    = function () {};    // attribute Function
  Hobs.onmessage = function () {};    // attribute Function
  Hobs.onclose   = function () {};    // attribute Function
  
  Hobs.close  = function () {};
  Hobs.send   = function send(data) {};
  
  /*
    Implementation of the interface above
  */
  Hobs.send = function (data) {
    Hobs.output_queue.push(data);
  }
  
  Hobs.onmessage = function (data) {
    $('#messages').append('['+data+']')
  }
  
  Hobs.Session    = { id: 0, request_id: 0, running: false };
  Hobs.Info       = { protocol: 'http', host: 'wstest.local', port:'8080'};
  
  Hobs.input_queue = new Array();
  Hobs.output_queue = new Array();
      
  function request() {

    var xhr = createXHR();
    
    Hobs.Session.request_id += 1;
    var test = 'hello dirk';
    
    xhr.open('POST', Hobs.Info.protocol+'://'+Hobs.Info.host+':'+Hobs.Info.port+'/test/');
    xhr.setRequestHeader("Content-Type", "text/plain");
    xhr.onreadystatechange = function(event) {
                    
      // Do it again, bosh-style
      if (xhr.readyState == 4) {
          
        Hobs.input_queue.push(xhr.responseText)
        setTimeout(Hobs.onmessage, 0, xhr.responseText);
        
        if (Hobs.Session.running) {
          setTimeout(request, 0);
        }
      }
        
    }
    
    if (Hobs.output_queue.length > 0) {
      var toSend = '';
      for(var i=0; i<Hobs.output_queue.length; i++) {
        toSend += Hobs.output_queue[i];
      }
  
      xhr.send(toSend);
    }
      
  }
      
  $('#bosh_start_first').click( function () {
      Hobs.Session.running = true;
      request();
  });
  
  
  $('#bosh_start_second').click( function () {
      Hobs.Session.running = true;
      request();
  });
  
  $('#bosh_stop').click( function () {
      Hobs.Session.running = false;
      for(var i=0; i< Hobs.input_queue.length; i++) {
          $('#messages').append(Hobs.input_queue[i]);
      }
  });
  
  $('#send_stuff').click( function () {
    Hobs.output_queue = new Array();

    Hobs.send($('#more_stuff').val());
    request();
  });
      
  // Utility section
  var createXHR = function () {
      try { return new XMLHttpRequest(); } catch(e) {}
      try { return new ActiveXObject('MSXML3.XMLHTTP'); } catch(e) {}
      try { return new ActiveXObject('MSXML2.XMLHTTP.3.0'); } catch(e) {}
      try { return new ActiveXObject('Msxml2.XMLHTTP'); } catch(e) {}
      try { return new ActiveXObject('Microsoft.XMLHTTP'); } catch(e) {}
      throw new Error('Could not find XMLHttpRequest or an alternative.');
  };
    
});

</script>

</body>
</html>