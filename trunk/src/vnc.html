<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head>
<title>jsVNC</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<script type="text/javascript" src="js/hobs.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.base64.js"></script>
<script type="text/javascript" src="js/vnc.js"></script>
<link rel="stylesheet" type="text/css" href="css/basic.css" media="screen" /> 
</head>
<body>

<div id="frame_container">

  <div id="panel" class="panel">
    <div id="pin"     class="btn icon pin"      title="Controls whether the panel should be visible.">Pin</div>
    <div id="refresh" class="btn icon refresh"  title="Request a full display update.">Refresh</div>
    <div id="scale"   class="btn icon scale"    title="Scale the display to fit in the current window.">Scale</div>

    <div class="info icon log">  
      <fieldset>    
      <pre id="log"></pre>      
      </fieldset>
      
      <span>Log</span>
    </div>
    <div id="more_log"></div>
    &nbsp;  
    
    <div id="con_status" class="info icon">
      
      <fieldset>
      
      <table>
        <tr><td>Bytes sent/recv</td><td><span id="bytes_sent">0</span>/<span id="bytes_recv">0</span></td></tr>
        <tr><td>Messages sent/recv</td><td><span id="msg_sent">0</span>/<span id="msg_recv">0</span></td></tr>
      </table>
      </fieldset>
      
      <span>Unknown</span>
  
    </div>
    <div id="host_status" class="info icon machine">
      
      <fieldset>
        
        <table>
          <tr><td>Hostname</td><td><span    id="hostname">Unknown</span></td></tr>
          <tr><td>Resolution</td><td><span  id="fb_res">0x0x0</span></td></tr>
          <tr><td>BPP</td><td><span id="fb_bpp">Unknown</span></td></tr>
          <tr><td>Color Depth</td><td><span id="fb_depth">Unknown</span></td></tr>
          <tr><td>Big Endian</td><td><span  id="fb_endian">Unknown</span></td></tr>
          <tr><td>True Color</td><td><span  id="fb_truecolor">Unknown</span></td></tr>
          <tr><td>RGB Max:</td><td>(<span   id="fb_rgbmax">,,</span>)</td></tr>
          <tr><td>RGB Shift:</td><td>(<span id="fb_rgbshift">,,</span>)</td></tr>
        </table>  
      </fieldset>
      
      <span>Unknown</span>
    </div>

    &nbsp;        
    <div class="info">
      
      <fieldset>
      
        <table>
          <tr>
            <td>VNC Host/Port</td>
            <td>
              <!--
            <input id="vnc_host" class="host" type="text" name="vnc_host" value="192.168.56.3"/>
              / <input id="vnc_port" type="text" class="port" name="vnc_port" value="5900"/>
            </td>
            -->
            <input id="vnc_host" class="host" type="text" name="vnc_host" value="localhost"/>
              / <input id="vnc_port" type="text" class="port" name="vnc_port" value="5900"/>
            </td>
          </tr>
          <tr>
            <td>WS Host/Port</td>
            <td>
                  <input id="ws_host"   class="host" type="text"  name="ws_host"    value="mifcho01"/>
               /  <input id="ws_port"   type="text"  class="port" name="ws_port"    value="8000"/>
               /  <input id="ws_peerid" type="text"  class="port" name="ws_peerid"  value="2222"/>
            </td>
          </tr>
        </table>
      
      </fieldset>
      
      <span id="connection" class="btn icon">Connect</span>
      
    </div>
  </div>

</div>

<script type="text/javascript">

$(document).ready(function(){
  
  // Load parameters from query-string
  var named_params  = new Array();  
  var query         = window.location.search.substring(1);
  var params        = query.split('&');
  var immediate_connect = 0;
  
  for (var i=0; i<params.length; i++) {
    var pos = params[i].indexOf('=');
    
    if (pos > 0) {
      var key = params[i].substring(0,pos);
      var val = params[i].substring(pos+1);
      named_params[key] = val;
    }
  }
  
  $('#vnc_host').val(named_params['vnc_host']);
  $('#vnc_port').val(named_params['vnc_port']);
  $('#ws_host').val(named_params['ws_host']);
  $('#ws_port').val(named_params['ws_port']);
  $('#ws_peerid').val(named_params['ws_peerid']);
  if (named_params['connect'] == 1) {
    immediate_connect = 1;
  }
  
  var gui = {
    'scaled': 0,
    'pinned': 1,
    'log': function (msg) {
      document.getElementById("log").innerHTML += (new Date()).toTimeString()+': '+msg+'\n';  
    },
    'created': false
  };
  
  var vnc;
  
  function bind_vnc() {
    
    // Check state, if not connected then do this:
    vnc = new Vnc({
      vnc_host: $('#vnc_host').val(),
      vnc_port: $('#vnc_port').val(),
      ws_host:  $('#ws_host').val(),
      ws_port:  $('#ws_port').val(),
      ws_peerid: $('#ws_peerid').val()
    });
    
    gui.created = true;
    vnc.connect();
    vnc.onstatechange = function (state) {
      
      if ((state > 0) && (state < 100)) {
        $('#con_status > span').html('Connecting');
        $('#con_status').removeClass('disconnected').addClass('connected');
      } else if ((state >= 100) && (state <200)) {
        $('#con_status > span').html('Handshaking');
        $('#con_status').removeClass('disconnected').addClass('connected');
      } else if ((state >= 200) && (state < 300)) {
        $('#con_status > span').html('Connected');
        $('#con_status').removeClass('disconnected').addClass('connected');
        
        /* GUI buttons */
    
        // Pin click
        $('#pin').click(function (event) {
  
          gui['pinned'] = gui['pinned']^1;
          
          if ($('#panel').hasClass('unpinned')) {
            $('#panel').removeClass('unpinned');
            $('#panel').removeClass('hidden');
            $('#pin').removeClass('unpin').addClass('pin');
          } else {
            $('#panel').addClass('unpinned');
            $('#panel').addClass('hidden');
            $('#pin').removeClass('pin').addClass('unpin');
          }
          
        });
        
        $('#connection').click(function () { vnc.disconnect(); } );
        
        // Refresh click
        $('#refresh').click(function (event) {    
          vnc.refresh();
        });
        
        // Scale click
        $('#scale').click(function () {
                
          var w = 0;
          var h = 0;
          
          // Toggle scaling
          gui['scaled'] = gui['scaled']^1;
          
          // Determine width and height
          if (gui['scaled'] == 1) {
            w = $(window).width();      
            h = $(window).height();
          } else {
            w = vnc.server_info.width;
            h = vnc.server_info.height
          }
          
          // Do scaling
          $('#frame_container canvas').width(w);
          $('#frame_container canvas').height(h);
          
          vnc.server_info.scaled = gui['scaled'];
          
        });
        
      } else if (state == 300) {
        $('#con_status > span').html('Disconnected');
        $('#con_status').removeClass('connected').addClass('disconnected');
        
      } else {
        $('#con_status > span').html('Unknown');
      }
      
    }
    
  }
  
  $('#connection').click(function () {
    
    if (gui.created) {
      
      gui.created=false;
      vnc.disconnect();
      bind_vnc();
      
    } else {
  
      bind_vnc();
      
    }  
    
  });
  
  if (immediate_connect == 1) {
    $('#connection').trigger('click');
  }
  
});

</script>

</body>
</html>

