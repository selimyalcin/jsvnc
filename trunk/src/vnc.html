<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head>
<title>jsVNC</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<script type="text/javascript" src="js/hobs.js"></script>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.base64.js"></script>
<script type="text/javascript" src="js/vnc.js"></script>
<link rel="stylesheet" type="text/css" href="css/basic.css" media="screen" /> 
</head>
<body>

  <div id="panel" class="panel">
    <div id="pin"     class="btn icon pin"      title="Controls whether the panel should be visible.">Pin</div>
    <div id="refresh" class="btn icon refresh"  title="Request a full display update.">Refresh</div>
    <div id="scale"   class="btn icon scale"    title="Scale the display to fit in the current window.">Scale</div>

    <div class="info icon log">  
      <fieldset>    
      <pre id="log"></pre>      
      </fieldset>
      
      <span>Log</span>
    </div>
    <div id="more_log"></div>
    &nbsp;  
    
    <div id="con_status" class="info icon">
      
      <fieldset>
      
      <table>
        <tr><td>Bytes sent/recv</td><td><span id="bytes_sent">0</span>/<span id="bytes_recv">0</span></td></tr>
        <tr><td>Messages sent/recv</td><td><span id="msg_sent">0</span>/<span id="msg_recv">0</span></td></tr>
      </table>
      </fieldset>
      
      <span>Unknown</span>
  
    </div>
    <div id="host_status" class="info icon machine">
      
      <fieldset>
        
        <table>
          <tr><td>Hostname</td><td><span    id="hostname">Unknown</span></td></tr>
          <tr><td>Resolution</td><td><span  id="fb_res">0x0x0</span></td></tr>
          <tr><td>BPP</td><td><span id="fb_bpp">Unknown</span></td></tr>
          <tr><td>Color Depth</td><td><span id="fb_depth">Unknown</span></td></tr>
          <tr><td>Big Endian</td><td><span  id="fb_endian">Unknown</span></td></tr>
          <tr><td>True Color</td><td><span  id="fb_truecolor">Unknown</span></td></tr>
          <tr><td>RGB Max:</td><td>(<span   id="fb_rgbmax">,,</span>)</td></tr>
          <tr><td>RGB Shift:</td><td>(<span id="fb_rgbshift">,,</span>)</td></tr>
        </table>  
      </fieldset>
      
      <span>Unknown</span>
    </div>

    &nbsp;        
    <div class="info">
      
      <fieldset>
      
        <table>
          <tr>
            <td>VNC Host/Port</td>
            <td>
            <input id="vnc_host" class="host" type="text" name="vnc_host" value="localhost"/>
              / <input id="vnc_port" type="text" class="port" name="vnc_port" value="5900"/>
            </td>
          </tr>
          <tr>
            <td>WS Host/Port</td>
            <td>
                  <input id="ws_host"   class="host" type="text"  name="ws_host"    value="mifcho01"/>
               /  <input id="ws_port"   type="text"  class="port" name="ws_port"    value="8000"/>
               /  <input id="ws_peerid" type="text"  class="port" name="ws_peerid"  value="2222"/>
            </td>
          </tr>
        </table>
      
      </fieldset>
      
      <span id="connection" class="btn icon">Connect</span>
      
    </div>
  </div>

<div id="frame_container" />

<script type="text/javascript">

$(document).ready(function(){
  
    // Load parameters from query-string
    var named_params  = new Array();  
    var query         = window.location.search.substring(1);
    var params        = query.split('&');
    var immediate_connect = 0;
    
    for (var i=0; i<params.length; i++) {
        var pos = params[i].indexOf('=');
        
        if (pos > 0) {
            var key = params[i].substring(0,pos);
            var val = params[i].substring(pos+1);
            named_params[key] = val;
        }
    }
    
    $('#vnc_host').val(named_params['vnc_host']);
    $('#vnc_port').val(named_params['vnc_port']);
    $('#ws_host').val(named_params['ws_host']);
    $('#ws_port').val(named_params['ws_port']);
    $('#ws_peerid').val(named_params['ws_peerid']);
    
    if (named_params['connect'] == 1) {
        immediate_connect = 1;
    }
    
    var n = 0;
    var ns = 5;
    var nodes = new Array(        
        {'host': 'mifcho01', 'port': '8001'},
        {'host': 'mifcho02', 'port': '8002'},
        {'host': 'mifcho03', 'port': '8003'},
        {'host': 'mifcho04', 'port': '8004'},
        {'host': 'mifcho05', 'port': '8005'}
    );
    
    var vnc;
    var gui = {
        'scaled': 0,
        'pinned': 1,
        'log': function (msg) {
            var date = new Date();
            document.getElementById("log").innerHTML = 'G '+date.getHours()+':'+date.getMinutes()+':'+date.getSeconds()+','+date.getMilliseconds()+': '+msg+'\n' +document.getElementById("log").innerHTML;        
        },
        'created': false,
        'update_info': function (server_info) {
            
            $('#host_status > span').html(server_info.name);
            $('#hostname').html(server_info.name);
            $('#fb_res').html(server_info.width+'x'+server_info.height);
            $('#fb_bpp').html(server_info.bpp);
            $('#fb_depth').html(server_info.depth);
            $('#fb_endian').html(server_info.big_endian);
            $('#fb_truecolor').html(server_info.true_color);
            $('#fb_rgbmax').html(server_info.red_max+','+server_info.green_max+','+server_info.blue_max);
            $('#fb_rgbshift').html(server_info.red_shift+','+server_info.green_shift+','+server_info.blue_shift);
        
        },
        'reset_info': function () {
            $('#host_status > span').html('Unknown');
            $('#hostname').html('Unknown');
            $('#fb_res').html('0x0');
            $('#fb_bpp').html('Unknown');
            $('#fb_depth').html('Unknown');
            $('#fb_endian').html('Unknown');
            $('#fb_truecolor').html('Unknown');
            $('#fb_rgbmax').html('(,,)');
            $('#fb_rgbshift').html('(,,)');
        }
    };
    
    /* GUI buttons */
    $('#pin').click(function (event) {

        gui['pinned'] = gui['pinned']^1;
        
        if ($('#panel').hasClass('unpinned')) {
            $('#panel').removeClass('unpinned');
            $('#panel').removeClass('hidden');
            $('#pin').removeClass('unpin').addClass('pin');
        } else {
            $('#panel').addClass('unpinned');
            $('#panel').addClass('hidden');
            $('#pin').removeClass('pin').addClass('unpin');
        }
      
    });
    
    // Refresh click
    $('#refresh').click(function (event) {
        
        if (vnc && (vnc.state >= 200) && (vnc.state < 300)) {
            vnc.refresh();    
        } else {
            self.log('ERR: Badly timed scaling, probably not connected.')
        }
        
    });
  
    // Scale click
    $('#scale').click(function () {        
        
        if (vnc && (vnc.state >= 200) && (vnc.state < 300)) {
            
            var w = 0;
            var h = 0;
                    
            gui['scaled'] = gui['scaled']^1;        // Toggle scaling
                    
            if (gui['scaled'] == 1) {               // Determine width and height
                w = $(window).width();      
                h = $(window).height();
            } else {
                w = vnc.server_info.width;
                h = vnc.server_info.height
            }
                    
            $('#frame_container canvas').width(w);  // Perform the actual scaling
            $('#frame_container canvas').height(h);
            
            vnc.server_info.scaled = gui['scaled'];
            
        } else {
            self.log('ERR: Badly timed scaling, probably not connected.')
        }
      
    });
                
    $('#connection').click(function () {
        
        if (vnc && (vnc.state >= 0) && (vnc.state < 300)) {
            gui.log("DIS while connected!!!");
            vnc.disconnect();
            vnc = null;
            
        } else if (vnc && (vnc.state == 300)) {
            gui.log("DIS while DISconnected?");
            vnc = null;
            bind_vnc();
        } else {
            gui.log("Connecting...");
            vnc = null;
            bind_vnc();
        }  
      
    });
    
    function bind_vnc() {
        
        vnc = new Vnc({
            vnc_host: $('#vnc_host').val(),
            vnc_port: $('#vnc_port').val(),
            ws_host:  nodes[n%ns].host,
            ws_port:  nodes[n%ns].port,
            ws_peerid: $('#ws_peerid').val()
        });  
        
        vnc.onstatechange = function (state) {
            
            if (state == 0) {
                
                gui.log('Connecting...'+state+' '+nodes[n%ns].host+':'+nodes[n%ns].port);
                $('#con_status > span').html('Connecting');
                $('#con_status').removeClass('disconnected').addClass('connected');
                $('#connection').html('Abort');
                
            } else if ((state > 0) && (state < 100)) {
                
                gui.log('Connecting...'+state+' '+nodes[n%ns].host+':'+nodes[n%ns].port);
                $('#con_status > span').html('Connecting');
                $('#con_status').removeClass('disconnected').addClass('connected');
                $('#connection').html('Abort');
                
            } else if ((state >= 100) && (state <200)) {
                
                gui.log('Handshaking...'+state+' '+nodes[n%ns].host+':'+nodes[n%ns].port);
                $('#con_status > span').html('Handshaking');
                $('#con_status').removeClass('disconnected').addClass('connected');
                $('#connection').html('Abort');
                
            } else if ((state >= 200) && (state < 300)) {
                
                gui.log('Connected.'+state+' '+nodes[n%ns].host+':'+nodes[n%ns].port);
                $('#con_status > span').html('Connected');
                $('#con_status').removeClass('disconnected').addClass('connected');
                $('#connection').html('Disconnect');
                
                gui.update_info(vnc.server_info);
        
            } else if (state == 300) {
                gui.log('Disconnected.'+state+' '+nodes[n%ns].host+':'+nodes[n%ns].port);
                $('#con_status > span').html('Disconnected');
                $('#con_status').removeClass('connected').addClass('disconnected');
                $('#connection').html('Connect');
                
                gui.reset_info();
                
                gui.log('Retrying in 5 seconds...')
                setTimeout(function () {
                    gui.log('Retrying now!')
                    $('#connection').trigger('click');
                },
                1000    // VNC SERVER IS TOO SLOW!
                        // SHOULD HANDLE THE INCORRECT SETUP OF A NEW CONNECTION!
                );
              
            } else {
                
                gui.log('ERROR UNKNOWN STATE! '+state);
                $('#con_status > span').html('Unknown');
            }
            
        }
        
        vnc.connect();
        n = n + 1;
      
    }

    if (immediate_connect == 1) {
        $('#connection').trigger('click');
    }

});

</script>

</body>
</html>

